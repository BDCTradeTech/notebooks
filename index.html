<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procesador de Archivos Excel de BDC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 2rem;
        }

        .upload-section {
            margin-bottom: 1.5rem;
        }

        .file-input-container {
            margin-bottom: 1rem;
        }

        input[type="file"] {
            display: none;
        }

        .file-input-label {
            display: block;
            padding: 1rem;
            background-color: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-label:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }

        .button {
            display: block;
            width: 100%;
            padding: 0.8rem;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }

        .button:hover {
            background-color: #0056b3;
        }

        .download-section {
            margin-top: 1rem;
        }

        #downloadButton {
            background-color: #28a745;
        }

        #downloadButton:hover {
            background-color: #218838;
        }

        .margen-bdc-container {
            margin-bottom: 1rem;
            font-family: inherit;
            font-size: 1rem;
            display: flex;
            align-items: center;
        }

        .margen-bdc-container label {
            margin-right: 10px;
            font-weight: 500;
        }

        .margen-bdc-container input[type="number"] {
            padding: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 1rem;
            width: 100px;
            font-family: inherit;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Procesador de Archivos Excel</h1>
        <div class="upload-section">
            <form id="uploadForm">
                <div class="file-input-container">
                    <input type="file" id="fileInput" accept=".xlsx, .xls" required>
                    <label for="fileInput" class="file-input-label">
                        Seleccionar archivo Excel
                    </label>
                </div>
                <div class="margen-bdc-container">
                    <label for="margenBDC">Margen BDC:</label>
                    <input type="number" id="margenBDC" step="0.1" value="5.0" min="0" required style="width: 80px; margin-left: 10px;">
                </div>
                <button type="submit" id="processButton" class="button">Procesar</button>
            </form>
        </div>
        <div id="downloadSection" class="download-section" style="display: none;">
            <button id="downloadButton" class="button">Descargar</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        const FAMILIAS = [
            'Intel Celeron',
            'Intel Pentium',
            'Intel Core 5',
            'Intel Core 7',
            'Intel Core i3',
            'Intel Core i5',
            'Intel Core i7',
            'Intel Core i9',
            'Intel Core Ultra5',
            'Intel Core Ultra7',
            'Intel Core Ultra9',
            'AMD Ryzen 3',
            'AMD Ryzen 5',
            'AMD Ryzen 7',
            'AMD Ryzen 9',
            'Apple'
        ];

        const PANTALLAS = [
            ['10.9', '10.9"'], ['11.6', '11.6"'], ['14', '14"'], ['14.1', '14.1"'], 
            ['13"', '13"'], ['15.6', '15.6"'], ['16', '16"'], ['16 inch', '16"'], 
            ['13.3 inch', '13.3"'], ['13IN', '13"']
        ];

        const MEMORIAS = [
            ['32GB', '32GB'], ['24GB', '24GB'], ['16GB', '16GB'], ['12GB', '12GB'],
            ['8GB', '8GB'], ['4GB', '4GB']
        ];

        const DISCOS = [
            ['512 GB', '512GB'], ['512G', '512GB'], ['128G', '128GB'], ['64GB', '64GB'], 
            ['256GB', '256GB'], ['127GB', '127GB'], ['1TB', '1TB']
        ];

        function extraerValor(descripcion, opciones, defaultVal = '-') {
            if (opciones === MEMORIAS) {
                // Para memorias, buscamos todas las coincidencias y tomamos la más grande
                let maxMemoria = null;
                let maxSize = 0;
                
                for (let [pattern, value] of opciones) {
                    if (descripcion.includes(pattern)) {
                        const size = parseInt(value);
                        if (size > maxSize) {
                            maxSize = size;
                            maxMemoria = value;
                        }
                    }
                }
                return maxMemoria || defaultVal;
            } else {
                // Para otros valores, comportamiento normal
                for (let [pattern, value] of opciones) {
                    if (descripcion.includes(pattern)) {
                        return value;
                    }
                }
                return defaultVal;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const uploadForm = document.getElementById('uploadForm');
            const fileInputLabel = document.querySelector('.file-input-label');
            const downloadSection = document.getElementById('downloadSection');
            const downloadButton = document.getElementById('downloadButton');
            let processedWorkbook = null;

            fileInput.addEventListener('change', function(e) {
                const fileName = e.target.files[0]?.name || 'Seleccionar archivo Excel';
                fileInputLabel.textContent = fileName;
            });

            uploadForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const file = fileInput.files[0];
                const margen = parseFloat(document.getElementById('margenBDC').value);
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // Procesar el archivo
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    // Encontrar la fila de cabecera
                    let headerRow = -1;
                    for (let i = 0; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row && row.some(cell => 
                            typeof cell === 'string' && 
                            ['sku', 'marca', 'qty', 'price', 'eta', 'moq'].includes(cell.toLowerCase())
                        )) {
                            headerRow = i;
                            break;
                        }
                    }

                    if (headerRow === -1) {
                        alert('No se encontró la fila de cabecera con las columnas requeridas');
                        return;
                    }

                    // Mapear columnas
                    const header = jsonData[headerRow].map(h => h.toLowerCase());
                    const colMap = {
                        sku: header.indexOf('sku'),
                        marca: header.indexOf('marca'),
                        descripcion: header.indexOf('descripcion') !== -1 ? header.indexOf('descripcion') : header.indexOf('descripción'),
                        qty: header.indexOf('qty'),
                        price: header.indexOf('price'),
                        eta: header.indexOf('eta'),
                        moq: header.indexOf('moq')
                    };

                    // Procesar datos
                    let familiaActual = null;
                    const processedData = [];
                    processedData.push(['SKU', 'Marca', 'Descripción', 'Familia', 'Pantalla', 'Memoria', 'Disco', 'Qty', 'Precio', 'ETA', 'MOQ']);

                    // Primero encontramos la primera familia
                    for (let i = headerRow + 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row && row.length > 0 && row[0] && FAMILIAS.includes(row[0])) {
                            familiaActual = row[0];
                            break;
                        }
                    }

                    // Si no encontramos ninguna familia, usamos la primera de la lista
                    if (!familiaActual) {
                        familiaActual = FAMILIAS[0];
                    }

                    for (let i = headerRow + 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row || row.length === 0) continue;

                        // Detectar si es una fila de grupo (familia)
                        if (row[0] && FAMILIAS.includes(row[0])) {
                            familiaActual = row[0];
                            continue;
                        }

                        // Procesar fila de datos
                        if (row[colMap.price]) {  // Solo verificamos que tenga precio
                            const descripcion = row[colMap.descripcion] || '';
                            const pantalla = extraerValor(descripcion, PANTALLAS);
                            const memoria = extraerValor(descripcion, MEMORIAS);
                            const disco = extraerValor(descripcion, DISCOS);
                            const precio = parseFloat(row[colMap.price]) * (1 + margen / 100);

                            processedData.push([
                                row[colMap.sku] || '-',  // Si no hay SKU, usamos '-'
                                row[colMap.marca] || '',
                                descripcion,
                                familiaActual,
                                pantalla,
                                memoria,
                                disco,
                                row[colMap.qty] || '',
                                precio,
                                row[colMap.eta] || '',
                                row[colMap.moq] !== undefined ? row[colMap.moq] : ''  // Si MOQ es 0, guardamos 0
                            ]);
                        }
                    }
                    
                    // Crear nuevo workbook
                    processedWorkbook = XLSX.utils.book_new();
                    const newSheet = XLSX.utils.aoa_to_sheet(processedData);
                    XLSX.utils.book_append_sheet(processedWorkbook, newSheet, "Notebooks");
                    
                    // Mostrar botón de descarga
                    downloadSection.style.display = 'block';
                };
                
                reader.readAsArrayBuffer(file);
            });

            downloadButton.addEventListener('click', function() {
                if (processedWorkbook) {
                    const fecha = new Date().toLocaleDateString('es-ES').replace(/\//g, '-');
                    XLSX.writeFile(processedWorkbook, `Notebooks BDC ${fecha}.xlsx`);
                }
            });
        });
    </script>
</body>
</html> 
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procesador de Archivos Excel de BDC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 2rem;
        }

        .upload-section {
            margin-bottom: 1.5rem;
        }

        .file-input-container {
            margin-bottom: 1rem;
        }

        input[type="file"] {
            display: none;
        }

        .file-input-label {
            display: block;
            padding: 1rem;
            background-color: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-label:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }

        .button {
            display: block;
            width: 100%;
            padding: 0.8rem;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }

        .button:hover {
            background-color: #0056b3;
        }

        .download-section {
            margin-top: 1rem;
        }

        #downloadButton {
            background-color: #28a745;
        }

        #downloadButton:hover {
            background-color: #218838;
        }

        .margen-bdc-container {
            margin-bottom: 1rem;
            font-family: inherit;
            font-size: 1rem;
            display: flex;
            align-items: center;
        }

        .margen-bdc-container label {
            margin-right: 10px;
            font-weight: 500;
        }

        .margen-bdc-container input[type="number"] {
            padding: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 1rem;
            width: 100px;
            font-family: inherit;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Procesador de Archivos Excel</h1>
        <div class="upload-section">
            <form id="uploadForm">
                <div class="file-input-container">
                    <input type="file" id="fileInput" accept=".xlsx, .xls" required>
                    <label for="fileInput" class="file-input-label">
                        Seleccionar archivo Excel
                    </label>
                </div>
                <div class="margen-bdc-container">
                    <label for="margenBDC">Margen BDC:</label>
                    <input type="number" id="margenBDC" step="0.1" value="5.0" min="0" required style="width: 80px; margin-left: 10px;">
                </div>
                <button type="submit" id="processButton" class="button">Procesar</button>
            </form>
        </div>
        <div id="downloadSection" class="download-section" style="display: none;">
            <button id="downloadButton" class="button">Descargar</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        const FAMILIAS = [
            'Intel Celeron',
            'Intel Pentium',
            'Intel Core 5',
            'Intel Core 7',
            'Intel Core i3',
            'Intel Core i5',
            'Intel Core i7',
            'Intel Core i9',
            'Intel Core Ultra5',
            'Intel Core Ultra7',
            'Intel Core Ultra9',
            'AMD Ryzen 3',
            'AMD Ryzen 5',
            'AMD Ryzen 7',
            'AMD Ryzen 9',
            'Apple'
        ];

        const PANTALLAS = [
            ['10.9', '10.9"'], ['11.6', '11.6"'], ['14', '14"'], ['14.1', '14.1"'], 
            ['13"', '13"'], ['13.3"', '13.3"'], ['13-inch', '13"'], ['15.6', '15.6"'], 
            ['16', '16"'], ['16 inch', '16"'], ['13.3 inch', '13.3"'], ['13IN', '13"']
        ];

        const MEMORIAS = [
            ['32GB', '32GB'], ['24GB', '24GB'], ['16GB', '16GB'], ['12GB', '12GB'],
            ['8GB', '8GB'], ['8G', '8GB'], ['4GB', '4GB']
        ];

        const DISCOS = [
            ['512 GB', '512GB'], ['512G', '512GB'], ['128G', '128GB'], ['64GB', '64GB'], 
            ['256GB', '256GB'], ['127GB', '127GB'], ['1TB', '1TB']
        ];

        let colMap = null;  // Variable global para colMap

        function esFilaCombinada(row) {
            // Una fila está combinada si no tiene precio pero tiene texto en la columna B (índice 1)
            return row && row.length > 1 && row[1] && !row[colMap.price];
        }

        function formatearPrecio(precio) {
            return precio.toLocaleString('es-ES', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function extraerValor(descripcion, opciones, defaultVal = '-') {
            if (opciones === MEMORIAS) {
                // Para memorias, buscamos todas las coincidencias y tomamos la más grande
                let maxMemoria = null;
                let maxSize = 0;
                
                for (let [pattern, value] of opciones) {
                    if (descripcion.includes(pattern)) {
                        const size = parseInt(value);
                        if (size > maxSize) {
                            maxSize = size;
                            maxMemoria = value;
                        }
                    }
                }
                return maxMemoria || defaultVal;
            } else {
                // Para otros valores, comportamiento normal
                for (let [pattern, value] of opciones) {
                    if (descripcion.includes(pattern)) {
                        return value;
                    }
                }
                return defaultVal;
            }
        }

        function extraerPantalla(descripcion) {
            // Primero buscar en los patrones definidos
            for (let [pattern, value] of PANTALLAS) {
                if (descripcion.includes(pattern)) {
                    return value;
                }
            }
            
            // Si no encuentra, buscar patrones como "11-", "14-", etc.
            const patrones = [
                ['11-', '11"'],
                ['14-', '14"'],
                ['15-', '15"'],
                ['13-', '13"'],
                ['16-', '16"']
            ];
            
            for (let [pattern, value] of patrones) {
                if (descripcion.includes(pattern)) {
                    return value;
                }
            }
            
            return '-';
        }

        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const uploadForm = document.getElementById('uploadForm');
            const fileInputLabel = document.querySelector('.file-input-label');
            const downloadSection = document.getElementById('downloadSection');
            const downloadButton = document.getElementById('downloadButton');
            let processedWorkbook = null;

            fileInput.addEventListener('change', function(e) {
                const fileName = e.target.files[0]?.name || 'Seleccionar archivo Excel';
                fileInputLabel.textContent = fileName;
            });

            uploadForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const file = fileInput.files[0];
                if (!file) {
                    alert('Por favor seleccione un archivo');
                    return;
                }

                const margen = parseFloat(document.getElementById('margenBDC').value);
                if (isNaN(margen)) {
                    alert('Por favor ingrese un margen válido');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        console.log('Iniciando procesamiento del archivo...');
                        const data = new Uint8Array(e.target.result);
                        console.log('Archivo leído correctamente');
                        
                        const workbook = XLSX.read(data, {type: 'array'});
                        console.log('Workbook creado correctamente');
                        
                        // Procesar el archivo
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        console.log('Primera hoja obtenida:', workbook.SheetNames[0]);
                        
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                        console.log('Datos convertidos a JSON');
                        
                        // Encontrar la fila de cabecera
                        let headerRow = -1;
                        for (let i = 0; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (row && row.some(cell => 
                                typeof cell === 'string' && 
                                ['sku', 'marca', 'qty', 'price', 'eta', 'moq'].includes(cell.toLowerCase())
                            )) {
                                headerRow = i;
                                break;
                            }
                        }

                        console.log('Fila de cabecera encontrada en:', headerRow);

                        if (headerRow === -1) {
                            throw new Error('No se encontró la fila de cabecera con las columnas requeridas');
                        }

                        // Mapear columnas
                        const header = jsonData[headerRow].map(h => h.toLowerCase());
                        console.log('Cabeceras encontradas:', header);
                        
                        colMap = {
                            sku: header.indexOf('sku'),
                            marca: header.indexOf('marca'),
                            descripcion: header.indexOf('descripcion') !== -1 ? header.indexOf('descripcion') : header.indexOf('descripción'),
                            qty: header.indexOf('qty'),
                            price: header.indexOf('price'),
                            eta: header.indexOf('eta'),
                            moq: header.indexOf('moq')
                        };

                        console.log('Columnas mapeadas:', colMap);

                        // Verificar que todas las columnas requeridas estén presentes
                        const columnasRequeridas = ['sku', 'marca', 'price', 'qty', 'eta', 'moq'];
                        const columnasFaltantes = columnasRequeridas.filter(col => colMap[col] === -1);
                        
                        if (columnasFaltantes.length > 0) {
                            throw new Error(`Faltan las siguientes columnas requeridas: ${columnasFaltantes.join(', ')}`);
                        }

                        // Procesar datos
                        let familiaActual = null;
                        const processedData = [];
                        processedData.push(['SKU', 'Marca', 'Descripción', 'Familia', 'Pantalla', 'Memoria', 'Disco', 'Qty', 'Precio', 'ETA', 'MOQ']);

                        console.log('Iniciando procesamiento de filas...');

                        // Primero encontramos la primera familia
                        for (let i = headerRow + 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (esFilaCombinada(row)) {
                                familiaActual = row[1];  // Usar el valor de la columna B
                                console.log('Primera familia encontrada:', familiaActual);
                                break;
                            }
                        }

                        for (let i = headerRow + 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            if (!row || row.length === 0) continue;

                            // Detectar si es una fila de grupo (familia)
                            if (esFilaCombinada(row)) {
                                familiaActual = row[1];  // Usar el valor de la columna B
                                console.log('Nueva familia encontrada:', familiaActual);
                                continue;
                            }

                            // Procesar fila de datos
                            if (row[colMap.price]) {  // Solo verificamos que tenga precio
                                const descripcion = row[colMap.descripcion] || '';
                                const pantalla = extraerPantalla(descripcion);
                                const memoria = extraerValor(descripcion, MEMORIAS);
                                const disco = extraerValor(descripcion, DISCOS);
                                const precio = parseFloat(row[colMap.price]) * (1 + margen / 100);

                                processedData.push([
                                    row[colMap.sku] || '-',  // Si no hay SKU, usamos '-'
                                    row[colMap.marca] || '',
                                    descripcion,
                                    familiaActual || '-',
                                    pantalla,
                                    memoria,
                                    disco,
                                    row[colMap.qty] || '',
                                    formatearPrecio(precio),
                                    row[colMap.eta] || '',
                                    row[colMap.moq] !== undefined ? row[colMap.moq] : ''  // Si MOQ es 0, guardamos 0
                                ]);
                            }
                        }
                        
                        console.log('Datos procesados correctamente');

                        // Crear nuevo workbook
                        processedWorkbook = XLSX.utils.book_new();
                        const newSheet = XLSX.utils.aoa_to_sheet(processedData);
                        
                        // Agregar filtros y estilo a la primera fila
                        newSheet['!autofilter'] = { ref: `A1:K1` };
                        
                        // Establecer estilo en negrita para la primera fila
                        for (let i = 0; i < 11; i++) {
                            const cellRef = XLSX.utils.encode_cell({r: 0, c: i});
                            if (!newSheet[cellRef]) newSheet[cellRef] = {};
                            newSheet[cellRef].s = { font: { bold: true } };
                        }
                        
                        XLSX.utils.book_append_sheet(processedWorkbook, newSheet, "Notebooks");
                        console.log('Workbook final creado correctamente');
                        
                        // Mostrar botón de descarga
                        downloadSection.style.display = 'block';
                        console.log('Procesamiento completado exitosamente');
                    } catch (error) {
                        console.error('Error detallado:', error);
                        alert(`Error al procesar el archivo: ${error.message}`);
                    }
                };
                
                reader.onerror = function() {
                    alert('Error al leer el archivo');
                };
                
                reader.readAsArrayBuffer(file);
            });

            downloadButton.addEventListener('click', function() {
                if (processedWorkbook) {
                    try {
                        const fecha = new Date().toLocaleDateString('es-ES').replace(/\//g, '-');
                        XLSX.writeFile(processedWorkbook, `Notebooks BDC ${fecha}.xlsx`);
                    } catch (error) {
                        console.error('Error al descargar el archivo:', error);
                        alert('Error al descargar el archivo. Por favor intente nuevamente.');
                    }
                } else {
                    alert('No hay archivo procesado para descargar');
                }
            });
        });
    </script>
</body>
</html> 